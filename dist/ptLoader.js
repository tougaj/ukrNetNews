"use strict";var __awaiter=this&&this.__awaiter||function(e,l,s,a){return new(s=s||Promise)(function(t,o){function r(e){try{n(a.next(e))}catch(e){o(e)}}function i(e){try{n(a.throw(e))}catch(e){o(e)}}function n(e){var o;e.done?t(e.value):((o=e.value)instanceof s?o:new s(function(e){e(o)})).then(r,i)}n((a=a.apply(e,l||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fs_1=__importDefault(require("fs")),moment_1=__importDefault(require("moment")),puppeteer_1=__importDefault(require("puppeteer")),common_1=require("./common"),TIMEOUT_BETWEEN_SESSIONS=3e5,browserOptions={width:800,height:600},argv=(fs_1.default.existsSync(common_1.OUTPUT_DIR)||fs_1.default.mkdirSync(common_1.OUTPUT_DIR),require("yargs").usage("Usage: node ./dist/$0 -p [str]").string(["p"]).alias("p","proxy").nargs("p",1).describe("p","Proxy configuration in format http://login:password@address:port/").help("h").alias("h","help").argv),proxyAddress=argv.proxy||"",init=()=>__awaiter(void 0,void 0,void 0,function*(){var e=yield puppeteer_1.default.launch({headless:!1,ignoreHTTPSErrors:!0,args:[`--window-size=${browserOptions.width},`+browserOptions.height,"--proxy-server="+proxyAddress]}),o=(yield e.pages())[0];return yield o.setUserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36"),yield o.setViewport({width:browserOptions.width-45,height:browserOptions.height,deviceScaleFactor:1}),yield o.goto("https://www.ukr.net/"),yield o.waitForSelector("body"),{browser:e,page:o}}),loadUkrNetNews=(n,l,{route:s,longTitle:a})=>__awaiter(void 0,void 0,void 0,function*(){var o=`https://www.ukr.net/news/dat/${s}/0/`;try{yield n.goto(o),yield n.waitForSelector("body");var e,t,r,i=yield n.$("body pre");if(i)return e=yield n.evaluate(e=>e.textContent,i),{tops:t,Title:r}=JSON.parse(e||""),console.log(`‚úÖ ${r} (${s}) loaded`),{route:s,title:r,longTitle:a,tops:(0,common_1.getNews)(l,t)};throw new Error('Can\'t find selector "body pre"')}catch(e){return console.log(`‚ùå !!! ERROR !!! ${s} not loaded from url: ${o} with error: `+e),null}}),loadAllNews=n=>__awaiter(void 0,void 0,void 0,function*(){var o={},t=[];for(let e=0;e<common_1.UKRNET_SECTIONS.length;e++){0!==e&&(r=Math.round(100+1e3*Math.random()),yield(0,common_1.sleep)(r));var{route:r,longTitle:i}=common_1.UKRNET_SECTIONS[e];t.push(yield loadUkrNetNews(n,o,{route:r,longTitle:i}))}var e={created:(0,moment_1.default)().toISOString(),news:t.filter(e=>null!==e),messages:o},e=JSON.stringify(e,null,"\t");fs_1.default.writeFileSync(common_1.OUTPUT_DIR+"/ukrnet.json",e)});__awaiter(void 0,void 0,void 0,function*(){let{browser:e,page:o}=yield init();for(;;){console.log("\nNews loading start at "+(0,moment_1.default)().format("HH:mm:ss"));try{e.isConnected()||({browser:e,page:o}=yield init()),yield loadAllNews(o),console.log("üü¢ News loaded at "+(0,moment_1.default)().format("HH:mm:ss"))}catch(e){console.log("üî¥ Error loading news "+e)}console.log("‚è∞ Next run at "+(0,moment_1.default)().add(TIMEOUT_BETWEEN_SESSIONS,"ms").format("HH:mm:ss")),yield(0,common_1.sleep)(TIMEOUT_BETWEEN_SESSIONS)}yield e.close()});